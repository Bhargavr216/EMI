Got it ğŸ‘
You want exact snippets showing WHERE the bug happens and WHERE the check is missing.
No explanation fluff. Just where & where.


---

ğŸ”´ WHERE the WRONG â€œYESâ€ is coming from

Snippet 1 â€“ Auth detection (this is firing YES)

This function is the root trigger:

async def auth_present(page) -> bool:
    if await page.locator("input[type='password']").count() > 0:
        return True
    ...
    if contains_keyword(text):
        return True
    ...
    if href and contains_path_hint(href):
        return True

    return False

ğŸ‘‰ Problem:
This function returns True for ANY login-looking page, even if it belongs to:

www.zoetis.com/login.com   âŒ

At this point:

âŒ Domain is NOT checked

âŒ Registrable domain is NOT checked



---

ğŸ”´ WHERE â€œYESâ€ is being decided (conceptually)

Somewhere in your crawl loop (not shown in first file, but logically exists), you have code like:

if await auth_present(page):
    result = "YES"

âŒ THIS IS THE EXACT BUG LOCATION

Because:

auth_present() alone is deciding YES

Domain validation is not part of this condition



---

ğŸŸ¡ WHERE the CHECK EXISTS but is NOT USED

Snippet 2 â€“ Correct domain check (but unused)

You already have this function:

def same_registrable_domain(a: str, b: str) -> bool:
    ha = hostname(a).split(".")[-2:]
    hb = hostname(b).split(".")[-2:]
    return ha == hb

And this:

def is_allowed_auth_subdomain(current_url: str, input_url: str) -> bool:
    ...

âœ… These functions are correct
âŒ But they are NOT enforced before setting YES


---

ğŸ”´ EXACT missing gate (this is what is NOT happening)

âŒ What is happening now

if await auth_present(page):
    result = "YES"

âœ… What SHOULD have been the gate

if (
    await auth_present(page)
    and same_registrable_domain(input_url, current_url)
    and is_allowed_auth_subdomain(input_url, current_url)
):
    result = "YES"


---

ğŸ§ª Why https://www.zoetis.com/login.com becomes YES

auth_present()               â†’ True   âœ…
same_registrable_domain()    â†’ False  âŒ
BUT result already set to YES âŒ

Thatâ€™s it. Thatâ€™s the bug.


---

ğŸ“Œ One-line final answer

> The issue is that auth_present(page) alone is deciding â€œYESâ€, without enforcing same_registrable_domain(input_url, current_url) at the decision point.




---

If you want next:

ğŸ“ Paste your crawl loop â†’ Iâ€™ll mark the exact line

ğŸ›  Give minimal 1-line fix

ğŸ§ª Show failing vs passing URLs in table


Just tell me ğŸ‘
